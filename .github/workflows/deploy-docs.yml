name: Deploy Documentation to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: |
            yarn.lock
            test-docusaurus-site/yarn.lock

      - name: Install dependencies (root)
        run: yarn install --frozen-lockfile

      - name: Run BDD tests
        run: yarn test

      - name: Install dependencies (docs site)
        working-directory: test-docusaurus-site
        run: yarn install --frozen-lockfile

      - name: Copy root docs to Docusaurus (single source of truth)
        run: |
          # Copy README.md with Docusaurus front-matter
          cat > test-docusaurus-site/docs/readme.md << 'EOF'
          ---
          id: readme
          title: README (GitHub)
          sidebar_label: README
          description: The main README file from the GitHub repository
          ---

          :::info Single Source of Truth
          This page is automatically copied from the repository root `README.md` file.
          The original file is maintained for GitHub and does not contain Docusaurus-specific markup.
          Edit the root `README.md` to update this page.
          :::

          ---

          EOF
          # Copy docs/img folder for README images
          mkdir -p test-docusaurus-site/docs/docs/img
          cp -r docs/img/* test-docusaurus-site/docs/docs/img/ 2>/dev/null || true

          # Fix links for Docusaurus: docs/adr/README.md -> ./adr/, docs/adr/ -> ./adr/, CONTRIBUTING.md -> ./contributing
          sed -e 's|(docs/adr/README.md)|(./adr/)|g' \
              -e 's|(docs/adr/|(./adr/|g' \
              -e 's|\[CONTRIBUTING.md\](CONTRIBUTING.md)|[Contributing](./contributing)|g' \
              README.md >> test-docusaurus-site/docs/readme.md

          # Copy CONTRIBUTING.md with Docusaurus front-matter
          cat > test-docusaurus-site/docs/contributing.md << 'EOF'
          ---
          id: contributing
          title: Contributing
          sidebar_label: Contributing
          description: How to contribute to remark-kroki-a11y
          ---

          :::info Single Source of Truth
          This page is automatically copied from the repository root `CONTRIBUTING.md` file.
          The original file is maintained for GitHub and does not contain Docusaurus-specific markup.
          Edit the root `CONTRIBUTING.md` to update this page.
          :::

          ---

          EOF
          cat CONTRIBUTING.md >> test-docusaurus-site/docs/contributing.md

          # Copy ADRs with front-matter
          mkdir -p test-docusaurus-site/docs/adr

          # Copy ADR index
          cat > test-docusaurus-site/docs/adr/index.md << 'EOF'
          ---
          id: index
          title: Architecture Decision Records
          sidebar_label: Overview
          description: Overview of Architecture Decision Records for remark-kroki-a11y
          ---

          :::info Single Source of Truth
          This page is automatically copied from `docs/adr/README.md` in the repository.
          Edit the source file to update this page.
          :::

          ---

          EOF
          cat docs/adr/README.md >> test-docusaurus-site/docs/adr/index.md

          # Copy each ADR file
          for adr_file in docs/adr/0*.md; do
            if [ -f "$adr_file" ]; then
              filename=$(basename "$adr_file")
              adr_num=$(echo "$filename" | grep -o '^[0-9]*')
              adr_slug=$(echo "$filename" | sed 's/^[0-9]*-//' | sed 's/\.md$//')
              adr_title=$(head -1 "$adr_file" | sed 's/^# //')

              cat > "test-docusaurus-site/docs/adr/$filename" << EOF
          ---
          id: $adr_slug
          title: "ADR-$adr_num: $adr_title"
          sidebar_label: "ADR-$adr_num"
          description: "Architecture Decision Record $adr_num"
          ---

          :::info Single Source of Truth
          This ADR is automatically copied from \`docs/adr/$filename\` in the repository.
          Edit the source file to update this page.
          :::

          ---

          EOF
              tail -n +2 "$adr_file" >> "test-docusaurus-site/docs/adr/$filename"
            fi
          done

          # Copy ADR images if they exist
          if [ -d "docs/adr/img" ]; then
            cp -r docs/adr/img test-docusaurus-site/docs/adr/
          fi
          if [ -d "docs/adr/images" ]; then
            cp -r docs/adr/images test-docusaurus-site/docs/adr/
          fi

      - name: Build documentation site
        working-directory: test-docusaurus-site
        run: yarn build
        env:
          NODE_ENV: production

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: test-docusaurus-site/build

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
